<?php
    // update report for monthly consumption
    $qty_m = $_POST['quantity_med'];
    $medicine = $_POST['medicine'];
    $qty_s = $_POST['quantity_sup'];
    $supply = $_POST['supply'];

    if($medicine != "" AND $supply != "")
    {
        $qty_m = $_POST['quantity_med'];
        $medicine = $_POST['medicine'];
        $qty_s = $_POST['quantity_sup'];
        $supply = $_POST['supply'];

        for($a = 0; $a < count($medicine); $a++)
        {
            $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
            $result = mysqli_query($conn, $query0);
            while(($data=mysqli_fetch_array($result)))
            {
                // kunin values from row
                $qty = $qty_m[$a];
                $aotqty = $data['tqty'];
                $aieqty = $data['eqty'];
                $aiiamt = $data['iamt']; 
                $aiiqty = $data['iqty'];
                $aieamt = $data['eamt']; //buc
                $cost = $data['eamt']/$data['eqty'];

                $tqty = $aotqty - $qty;
                $eqty = $qty - $aieqty;

                if ($data['tqty'] == 0 )
                {
                    $aobuc = 0;
                    $abuc = number_format($aobuc, 2, ".");
                }
                else
                {
                    $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                    $abuc = number_format($aobuc, 2, ".");
                }

                if($data['iqty'] == 0)
                {
                    $iamt = 0;
                    $iqty = 0;
                }
                else
                {
                    $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                    $iqty = $data['iqty'];
                }
            }

            $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
            eqty = '$eqty', eamt = '$aeamt' 
            WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
            mysqli_query($conn, $query2);
        }
        for($b = 0; $b < count($supply); $b++)
        {
            $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
            $result = mysqli_query($conn, $query0);
            while(($data=mysqli_fetch_array($result)))
            {
                // kunin values from row
                $qty = $qty_s[$b];
                $aotqty = $data['tqty'];
                $aieqty = $data['eqty'];
                $aiiamt = $data['iamt']; 
                $aiiqty = $data['iqty'];
                $aieamt = $data['eamt']; //buc
                $cost = $data['eamt']/$data['eqty'];

                $tqty = $aotqty - $qty;
                $eqty = $qty - $aieqty;

                if ($data['tqty'] == 0 )
                {
                    $aobuc = 0;
                    $abuc = number_format($aobuc, 2, ".");
                }
                else
                {
                    $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                    $abuc = number_format($aobuc, 2, ".");
                }

                if($data['iqty'] == 0)
                {
                    $iamt = 0;
                    $iqty = 0;
                }
                else
                {
                    $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                    $iqty = $data['iqty'];
                }
            }

            $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
            eqty = '$eqty', eamt = '$aeamt' 
            WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
            mysqli_query($conn, $query2);
        }

        $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
        if($result = mysqli_query($conn, $sql))
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
        else
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
    }
    elseif($medicine == "" AND $supply != "")
    {
        $qty_s = $_POST['quantity_sup'];
        $supply = $_POST['supply'];
        for($b = 0; $b < count($supply); $b++)
        {
            $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
            $result = mysqli_query($conn, $query0);
            while(($data=mysqli_fetch_array($result)))
            {
                // kunin values from row
                $qty = $qty_s[$b];
                $aotqty = $data['tqty'];
                $aieqty = $data['eqty'];
                $aiiamt = $data['iamt']; 
                $aiiqty = $data['iqty'];
                $aieamt = $data['eamt']; //buc
                $cost = $data['eamt']/$data['eqty'];

                $tqty = $aotqty - $qty;
                $eqty = $qty - $aieqty;

                if ($data['tqty'] == 0 )
                {
                    $aobuc = 0;
                    $abuc = number_format($aobuc, 2, ".");
                }
                else
                {
                    $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                    $abuc = number_format($aobuc, 2, ".");
                }

                if($data['iqty'] == 0)
                {
                    $iamt = 0;
                    $iqty = 0;
                }
                else
                {
                    $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                    $iqty = $data['iqty'];
                }
            }

            $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
            eqty = '$eqty', eamt = '$aeamt' 
            WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
            mysqli_query($conn, $query2);
        }

        $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
        if($result = mysqli_query($conn, $sql))
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
        else
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
    }
    elseif($medicine != "" AND $supply == "")
    {
        $qty_m = $_POST['quantity_med'];
        $medicine = $_POST['medicine'];

        for($a = 0; $a < count($medicine); $a++)
        {
            $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
            $result = mysqli_query($conn, $query0);
            while(($data=mysqli_fetch_array($result)))
            {
                // kunin values from row
                $qty = $qty_m[$a];
                $aotqty = $data['tqty'];
                $aieqty = $data['eqty'];
                $aiiamt = $data['iamt']; 
                $aiiqty = $data['iqty'];
                $aieamt = $data['eamt']; //buc
                $cost = $data['eamt']/$data['eqty'];

                $tqty = $aotqty - $qty;
                $eqty = $qty - $aieqty;

                if ($data['tqty'] == 0 )
                {
                    $aobuc = 0;
                    $abuc = number_format($aobuc, 2, ".");
                }
                else
                {
                    $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                    $abuc = number_format($aobuc, 2, ".");
                }

                if($data['iqty'] == 0)
                {
                    $iamt = 0;
                    $iqty = 0;
                }
                else
                {
                    $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                    $iqty = $data['iqty'];
                }
            }

            $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
            eqty = '$eqty', eamt = '$aeamt' 
            WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
            mysqli_query($conn, $query2);
        }

        $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
        if($result = mysqli_query($conn, $sql))
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
        else
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
    }
    else
    {
        $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
        if($result = mysqli_query($conn, $sql))
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
        else
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
    }
    
    



    //update inventory by batch -- status muna
    $qty_m = $_POST['quantity_med'];
    $medicine = $_POST['medicine'];
    $qty_s = $_POST['quantity_sup'];
    $supply = $_POST['supply'];

    if($medicine != "" AND $supply != "")
    {
        $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
        $result = mysqli_query($conn, $query0);
        while($data=mysqli_num_rows($result))
        {
            $mstat = $data['status'];
        }
        $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
        $result = mysqli_query($conn, $query1);
        while($data=mysqli_num_rows($result))
        {
            $sstat = $data['status'];
        }

        if($mstat != 'open-close')
        {
            //add inventory by batch
            $datenow = date("Y-m-d");

            $query0 = "UPDATE inventory SET
            closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
            WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
            AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
            if(mysqli_query($conn, $query0))
            {
                // update report for monthly consumption
                if($medicine != "" AND $supply != "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];

                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];

                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;

                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }

                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }

                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];

                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;

                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }

                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }

                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }

                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];

                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;

                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }

                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }

                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }

                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];

                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];

                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;

                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }

                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }

                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }

                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
            else
            {
                // update report for monthly consumption
                if($medicine != "" AND $supply != "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
        }
        else
        {
            // update report for monthly consumption
            if($medicine != "" AND $supply != "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine == "" AND $supply != "")
            {
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine != "" AND $supply == "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            else
            {
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
        }

        if($sstat != 'open-close')
        {
            //add inventory by batch
            $datenow = date("Y-m-d");

            $query0 = "UPDATE inventory SET
            closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
            WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
            AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
            if(mysqli_query($conn, $query0))
            {
                // update report for monthly consumption
                if($medicine != "" AND $supply != "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
            else
            {
                // update report for monthly consumption
                if($medicine != "" AND $supply != "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
        }
        else
        {
            // update report for monthly consumption
            if($medicine != "" AND $supply != "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];

                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];

                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;

                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }

                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }

                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];

                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;

                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }

                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }

                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }

                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine == "" AND $supply != "")
            {
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];

                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;

                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }

                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }

                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }

                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine != "" AND $supply == "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];

                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];

                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;

                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }

                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }

                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }

                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            else
            {
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
        }
    }
    elseif($medicine == "" AND $supply != "")
    {
        $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
        $result = mysqli_query($conn, $query1);
        while($data=mysqli_num_rows($result))
        {
            $sstat = $data['status'];
        }
        if($sstat != 'open-close')
        {
            //add inventory by batch
            $datenow = date("Y-m-d");

            $query0 = "UPDATE inventory SET
            closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
            WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
            AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
            if(mysqli_query($conn, $query0))
            {
                // update report for monthly consumption
                if($medicine != "" AND $supply != "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
            else
            {
                // update report for monthly consumption
                if($medicine != "" AND $supply != "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
        }
        else
        {
            // update report for monthly consumption
            if($medicine != "" AND $supply != "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];

                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];

                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;

                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }

                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }

                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];

                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;

                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }

                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }

                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }

                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine == "" AND $supply != "")
            {
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];

                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;

                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }

                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }

                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }

                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine != "" AND $supply == "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];

                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];

                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;

                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }

                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }

                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }

                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            else
            {
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
        }
    }
    elseif($medicine != "" AND $supply == "")
    {
        $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
        $result = mysqli_query($conn, $query0);
        while($data=mysqli_num_rows($result))
        {
            $mstat = $data['status'];
        }

        if($mstat != 'open-close')
        {
            //add inventory by batch
            $datenow = date("Y-m-d");

            $query0 = "UPDATE inventory SET
            closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
            WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
            AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
            if(mysqli_query($conn, $query0))
            {
                // update report for monthly consumption
                if($medicine != "" AND $supply != "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];

                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];

                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;

                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }

                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }

                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];

                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;

                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }

                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }

                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }

                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];

                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;

                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }

                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }

                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }

                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];

                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];

                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;

                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }

                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }

                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }

                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
            else
            {
                // update report for monthly consumption
                if($medicine != "" AND $supply != "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $qty_s = $_POST['quantity_sup'];
                    $supply = $_POST['supply'];
                    for($b = 0; $b < count($supply); $b++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_s[$b];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $qty_m = $_POST['quantity_med'];
                    $medicine = $_POST['medicine'];
            
                    for($a = 0; $a < count($medicine); $a++)
                    {
                        $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                        $result = mysqli_query($conn, $query0);
                        while(($data=mysqli_fetch_array($result)))
                        {
                            // kunin values from row
                            $qty = $qty_m[$a];
                            $aotqty = $data['tqty'];
                            $aieqty = $data['eqty'];
                            $aiiamt = $data['iamt']; 
                            $aiiqty = $data['iqty'];
                            $aieamt = $data['eamt']; //buc
                            $cost = $data['eamt']/$data['eqty'];
            
                            $tqty = $aotqty - $qty;
                            $eqty = $qty - $aieqty;
            
                            if ($data['tqty'] == 0 )
                            {
                                $aobuc = 0;
                                $abuc = number_format($aobuc, 2, ".");
                            }
                            else
                            {
                                $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                $abuc = number_format($aobuc, 2, ".");
                            }
            
                            if($data['iqty'] == 0)
                            {
                                $iamt = 0;
                                $iqty = 0;
                            }
                            else
                            {
                                $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                $iqty = $data['iqty'];
                            }
                        }
            
                        $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                        eqty = '$eqty', eamt = '$aeamt' 
                        WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                        mysqli_query($conn, $query2);
                    }
            
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
        }
        else
        {
            // update report for monthly consumption
            if($medicine != "" AND $supply != "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine == "" AND $supply != "")
            {
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine != "" AND $supply == "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            else
            {
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
        }
    }
    else
    {
        $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
        if($result = mysqli_query($conn, $sql))
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
        else
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
    }








    




    // update inventory_total -- status muna

    
    $qty_m = $_POST['quantity_med'];
    $medicine = $_POST['medicine'];
    $qty_s = $_POST['quantity_sup'];
    $supply = $_POST['supply'];

    if($medicine != "" AND $supply != "")
    {
        $qty_m = $_POST['quantity_med'];
        $medicine = $_POST['medicine'];
        $qty_s = $_POST['quantity_sup'];
        $supply = $_POST['supply'];

        $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
        $result = mysqli_query($conn, $query0);
        while($data=mysqli_num_rows($result))
        {
            $mstat = $data['status'];
        }
        $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
        $result = mysqli_query($conn, $query1);
        while($data=mysqli_num_rows($result))
        {
            $sstat = $data['status'];
        }
    
        if($mstat != 'open-close')
        {
            $query = "UPDATE inv_total SET 
            closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
            WHERE stockid='$medicine[$a]'";
            if(mysqli_query($conn, $query))
            {
                //update inventory by batch -- status muna
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
            
                if($medicine != "" AND $supply != "")
                {
                    $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
                    $result = mysqli_query($conn, $query0);
                    while($data=mysqli_num_rows($result))
                    {
                        $mstat = $data['status'];
                    }
                    $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
                    $result = mysqli_query($conn, $query1);
                    while($data=mysqli_num_rows($result))
                    {
                        $sstat = $data['status'];
                    }
            
                    if($mstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
                        WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
            
                    if($sstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
                        WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
                    $result = mysqli_query($conn, $query1);
                    while($data=mysqli_num_rows($result))
                    {
                        $sstat = $data['status'];
                    }
                    if($sstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
                        WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
                    $result = mysqli_query($conn, $query0);
                    while($data=mysqli_num_rows($result))
                    {
                        $mstat = $data['status'];
                    }
            
                    if($mstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
                        WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
        }
        else
        {
            // update report for monthly consumption
            $qty_m = $_POST['quantity_med'];
            $medicine = $_POST['medicine'];
            $qty_s = $_POST['quantity_sup'];
            $supply = $_POST['supply'];
        
            if($medicine != "" AND $supply != "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine == "" AND $supply != "")
            {
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine != "" AND $supply == "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            else
            {
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
        }
        
        if($sstat != 'open-close')
        {
            $query = "UPDATE inv_total SET 
            closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
            WHERE stockid='$supply[$b]'";
            if(mysqli_query($conn, $query))
            {
                //update inventory by batch -- status muna
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
            
                if($medicine != "" AND $supply != "")
                {
                    $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
                    $result = mysqli_query($conn, $query0);
                    while($data=mysqli_num_rows($result))
                    {
                        $mstat = $data['status'];
                    }
                    $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
                    $result = mysqli_query($conn, $query1);
                    while($data=mysqli_num_rows($result))
                    {
                        $sstat = $data['status'];
                    }
            
                    if($mstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
                        WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
            
                    if($sstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
                        WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
                    $result = mysqli_query($conn, $query1);
                    while($data=mysqli_num_rows($result))
                    {
                        $sstat = $data['status'];
                    }
                    if($sstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
                        WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
                    $result = mysqli_query($conn, $query0);
                    while($data=mysqli_num_rows($result))
                    {
                        $mstat = $data['status'];
                    }
            
                    if($mstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
                        WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
        }
        else
        {
            // update report for monthly consumption
            $qty_m = $_POST['quantity_med'];
            $medicine = $_POST['medicine'];
            $qty_s = $_POST['quantity_sup'];
            $supply = $_POST['supply'];
        
            if($medicine != "" AND $supply != "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine == "" AND $supply != "")
            {
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine != "" AND $supply == "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            else
            {
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
        }
    }
    elseif($medicine == "" AND $supply != "")
    {
        $qty_s = $_POST['quantity_sup'];
        $supply = $_POST['supply'];

        $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
        $result = mysqli_query($conn, $query1);
        while($data=mysqli_num_rows($result))
        {
            $sstat = $data['status'];
        }
        if($sstat != 'open-close')
        {
            $query = "UPDATE inv_total SET 
            closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
            WHERE stockid='$supply[$b]'";
            if(mysqli_query($conn, $query))
            {
                //update inventory by batch -- status muna
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
            
                if($medicine != "" AND $supply != "")
                {
                    $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
                    $result = mysqli_query($conn, $query0);
                    while($data=mysqli_num_rows($result))
                    {
                        $mstat = $data['status'];
                    }
                    $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
                    $result = mysqli_query($conn, $query1);
                    while($data=mysqli_num_rows($result))
                    {
                        $sstat = $data['status'];
                    }
            
                    if($mstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
                        WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
            
                    if($sstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
                        WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
                    $result = mysqli_query($conn, $query1);
                    while($data=mysqli_num_rows($result))
                    {
                        $sstat = $data['status'];
                    }
                    if($sstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
                        WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
                    $result = mysqli_query($conn, $query0);
                    while($data=mysqli_num_rows($result))
                    {
                        $mstat = $data['status'];
                    }
            
                    if($mstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
                        WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
        }
        else
        {
            // update report for monthly consumption
            $qty_m = $_POST['quantity_med'];
            $medicine = $_POST['medicine'];
            $qty_s = $_POST['quantity_sup'];
            $supply = $_POST['supply'];
        
            if($medicine != "" AND $supply != "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine == "" AND $supply != "")
            {
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine != "" AND $supply == "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            else
            {
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
        }
    }
    elseif($medicine != "" AND $supply == "")
    {
        $qty_m = $_POST['quantity_med'];
        $medicine = $_POST['medicine'];
        $qty_s = $_POST['quantity_sup'];
        $supply = $_POST['supply'];
        
        $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
        $result = mysqli_query($conn, $query0);
        while($data=mysqli_num_rows($result))
        {
            $mstat = $data['status'];
        }
    
        if($mstat != 'open-close')
        {
            $query = "UPDATE inv_total SET 
            closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
            WHERE stockid='$medicine[$a]'";
            if(mysqli_query($conn, $query))
            {
                //update inventory by batch -- status muna
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
            
                if($medicine != "" AND $supply != "")
                {
                    $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
                    $result = mysqli_query($conn, $query0);
                    while($data=mysqli_num_rows($result))
                    {
                        $mstat = $data['status'];
                    }
                    $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
                    $result = mysqli_query($conn, $query1);
                    while($data=mysqli_num_rows($result))
                    {
                        $sstat = $data['status'];
                    }
            
                    if($mstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
                        WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
            
                    if($sstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
                        WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                elseif($medicine == "" AND $supply != "")
                {
                    $query1 = "SELECT status FROM supply WHERE supid = '$supply[$b]";   
                    $result = mysqli_query($conn, $query1);
                    while($data=mysqli_num_rows($result))
                    {
                        $sstat = $data['status'];
                    }
                    if($sstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$supply[$b]', qty = qty - '$supply[$b]'
                        WHERE campus='$campus' AND stock_type='supply' AND stockid='$supply[$b]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
            
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
            
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
            
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
            
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
            
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
            
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                elseif($medicine != "" AND $supply == "")
                {
                    $query0 = "SELECT status FROM medicine WHERE medid = '$medicine[$a]";    
                    $result = mysqli_query($conn, $query0);
                    while($data=mysqli_num_rows($result))
                    {
                        $mstat = $data['status'];
                    }
            
                    if($mstat != 'open-close')
                    {
                        //add inventory by batch
                        $datenow = date("Y-m-d");
            
                        $query0 = "UPDATE inventory SET
                        closed = closed - '$medicine[$a]', qty = qty - '$medicine[$a]'
                        WHERE campus='$campus' AND stock_type='medicine' AND stockid='$medicine[$a]'
                        AND qty != 0 AND expiration > $datenow ORDER BY date LIMIT 1";
                        if(mysqli_query($conn, $query0))
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
            
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
            
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
            
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
            
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
            
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
            
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                        else
                        {
                            // update report for monthly consumption
                            if($medicine != "" AND $supply != "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine == "" AND $supply != "")
                            {
                                $qty_s = $_POST['quantity_sup'];
                                $supply = $_POST['supply'];
                                for($b = 0; $b < count($supply); $b++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_s[$b];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            elseif($medicine != "" AND $supply == "")
                            {
                                $qty_m = $_POST['quantity_med'];
                                $medicine = $_POST['medicine'];
                        
                                for($a = 0; $a < count($medicine); $a++)
                                {
                                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                    $result = mysqli_query($conn, $query0);
                                    while(($data=mysqli_fetch_array($result)))
                                    {
                                        // kunin values from row
                                        $qty = $qty_m[$a];
                                        $aotqty = $data['tqty'];
                                        $aieqty = $data['eqty'];
                                        $aiiamt = $data['iamt']; 
                                        $aiiqty = $data['iqty'];
                                        $aieamt = $data['eamt']; //buc
                                        $cost = $data['eamt']/$data['eqty'];
                        
                                        $tqty = $aotqty - $qty;
                                        $eqty = $qty - $aieqty;
                        
                                        if ($data['tqty'] == 0 )
                                        {
                                            $aobuc = 0;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                                        else
                                        {
                                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                            $abuc = number_format($aobuc, 2, ".");
                                        }
                        
                                        if($data['iqty'] == 0)
                                        {
                                            $iamt = 0;
                                            $iqty = 0;
                                        }
                                        else
                                        {
                                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                            $iqty = $data['iqty'];
                                        }
                                    }
                        
                                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                    eqty = '$eqty', eamt = '$aeamt' 
                                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                    mysqli_query($conn, $query2);
                                }
                        
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                            else
                            {
                                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                                if($result = mysqli_query($conn, $sql))
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                                else
                                {
                                    ?>
                                    <script>
                                        setTimeout(function() {
                                            window.location = " ../transaction_add.php";
                                        });
                                    </script>
                                    <?php
                                    // modal message box saying "Transaction was recorded."
                                }
                            }
                        }
                    }
                    else
                    {
                        // update report for monthly consumption
                        if($medicine != "" AND $supply != "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine == "" AND $supply != "")
                        {
                            $qty_s = $_POST['quantity_sup'];
                            $supply = $_POST['supply'];
                            for($b = 0; $b < count($supply); $b++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_s[$b];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        elseif($medicine != "" AND $supply == "")
                        {
                            $qty_m = $_POST['quantity_med'];
                            $medicine = $_POST['medicine'];
                    
                            for($a = 0; $a < count($medicine); $a++)
                            {
                                $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                                $result = mysqli_query($conn, $query0);
                                while(($data=mysqli_fetch_array($result)))
                                {
                                    // kunin values from row
                                    $qty = $qty_m[$a];
                                    $aotqty = $data['tqty'];
                                    $aieqty = $data['eqty'];
                                    $aiiamt = $data['iamt']; 
                                    $aiiqty = $data['iqty'];
                                    $aieamt = $data['eamt']; //buc
                                    $cost = $data['eamt']/$data['eqty'];
                    
                                    $tqty = $aotqty - $qty;
                                    $eqty = $qty - $aieqty;
                    
                                    if ($data['tqty'] == 0 )
                                    {
                                        $aobuc = 0;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                                    else
                                    {
                                        $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                                        $abuc = number_format($aobuc, 2, ".");
                                    }
                    
                                    if($data['iqty'] == 0)
                                    {
                                        $iamt = 0;
                                        $iqty = 0;
                                    }
                                    else
                                    {
                                        $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                                        $iqty = $data['iqty'];
                                    }
                                }
                    
                                $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                                eqty = '$eqty', eamt = '$aeamt' 
                                WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                                mysqli_query($conn, $query2);
                            }
                    
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                        else
                        {
                            $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                            if($result = mysqli_query($conn, $sql))
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                            else
                            {
                                ?>
                                <script>
                                    setTimeout(function() {
                                        window.location = " ../transaction_add.php";
                                    });
                                </script>
                                <?php
                                // modal message box saying "Transaction was recorded."
                            }
                        }
                    }
                }
                else
                {
                    $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                    if($result = mysqli_query($conn, $sql))
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                    else
                    {
                        ?>
                        <script>
                            setTimeout(function() {
                                window.location = " ../transaction_add.php";
                            });
                        </script>
                        <?php
                        // modal message box saying "Transaction was recorded."
                    }
                }
            }
        }
        else
        {
            // update report for monthly consumption
            $qty_m = $_POST['quantity_med'];
            $medicine = $_POST['medicine'];
            $qty_s = $_POST['quantity_sup'];
            $supply = $_POST['supply'];
        
            if($medicine != "" AND $supply != "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine == "" AND $supply != "")
            {
                $qty_s = $_POST['quantity_sup'];
                $supply = $_POST['supply'];
                for($b = 0; $b < count($supply); $b++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$supply[$b]' AND type = 'supply' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_s[$b];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$supply[$b]' AND date = '$enddate' AND type = 'supply' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            elseif($medicine != "" AND $supply == "")
            {
                $qty_m = $_POST['quantity_med'];
                $medicine = $_POST['medicine'];
        
                for($a = 0; $a < count($medicine); $a++)
                {
                    $query0 = "SELECT * FROM report_medsupinv WHERE medid = '$medicine[$a]' AND type = 'medicine' AND date = '$enddate' AND campus = '$campus'";    
                    $result = mysqli_query($conn, $query0);
                    while(($data=mysqli_fetch_array($result)))
                    {
                        // kunin values from row
                        $qty = $qty_m[$a];
                        $aotqty = $data['tqty'];
                        $aieqty = $data['eqty'];
                        $aiiamt = $data['iamt']; 
                        $aiiqty = $data['iqty'];
                        $aieamt = $data['eamt']; //buc
                        $cost = $data['eamt']/$data['eqty'];
        
                        $tqty = $aotqty - $qty;
                        $eqty = $qty - $aieqty;
        
                        if ($data['tqty'] == 0 )
                        {
                            $aobuc = 0;
                            $abuc = number_format($aobuc, 2, ".");
                        }
                        else
                        {
                            $aobuc = ($data['eamt'] - ($qty * $cost)) / $eqty;
                            $abuc = number_format($aobuc, 2, ".");
                        }
        
                        if($data['iqty'] == 0)
                        {
                            $iamt = 0;
                            $iqty = 0;
                        }
                        else
                        {
                            $iamt = $data['iqty'] * (($data['eamt'] - ($qty * $cost)) / $eqty);
                            $iqty = $data['iqty'];
                        }
                    }
        
                    $query2 = "UPDATE report_medsupinv SET iqty = '$iqty', iamt = '$iamt' 
                    eqty = '$eqty', eamt = '$aeamt' 
                    WHERE medid = '$medicine[$a]' AND date = '$enddate' AND type = 'medicine' AND campus = '$campus'";
                    mysqli_query($conn, $query2);
                }
        
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
            else
            {
                $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
                if($result = mysqli_query($conn, $sql))
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
                else
                {
                    ?>
                    <script>
                        setTimeout(function() {
                            window.location = " ../transaction_add.php";
                        });
                    </script>
                    <?php
                    // modal message box saying "Transaction was recorded."
                }
            }
        }
    }
    else
    {
        $sql = "INSERT INTO audit_trail (user, fullname, campus, activity, status, datetime) VALUES ('$user', '$fullname', '$campus', '$activity', '$au_status', now())";
        if($result = mysqli_query($conn, $sql))
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
        else
        {
            ?>
            <script>
                setTimeout(function() {
                    window.location = " ../transaction_add.php";
                });
            </script>
            <?php
            // modal message box saying "Transaction was recorded."
        }
    }

    















































    
                
?>